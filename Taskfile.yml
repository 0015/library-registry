version: "3"

tasks:
  docs:check-license:
    desc: Check if the license file is correctly formatted
    cmds:
      - |
        EXPECTED_LICENSE_FILE="\"LICENSE.txt\""
        EXPECTED_LICENSE_TYPE="\"GPL-3.0\"" # https://spdx.org/licenses/

        # See: https://github.com/licensee/licensee
        LICENSEE_OUTPUT="$(licensee detect --json --confidence=100)"

        DETECTED_LICENSE_FILE="$(echo "$LICENSEE_OUTPUT" | jq .matched_files[0].filename | tr --delete '\r')"
        echo "Detected license file: $DETECTED_LICENSE_FILE"
        if [ "$DETECTED_LICENSE_FILE" != "$EXPECTED_LICENSE_FILE" ]; then
          echo "ERROR: detected license file doesn't match expected: $EXPECTED_LICENSE_FILE"
          exit 1
        fi

        DETECTED_LICENSE_TYPE="$(echo "$LICENSEE_OUTPUT" | jq .matched_files[0].matched_license | tr --delete '\r')"
        echo "Detected license type: $DETECTED_LICENSE_TYPE"
        if [ "$DETECTED_LICENSE_TYPE" != "$EXPECTED_LICENSE_TYPE" ]; then
          echo "ERROR: detected license type doesn't match expected $EXPECTED_LICENSE_TYPE"
          exit 1
        fi

